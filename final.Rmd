---
title: "final project"
author: "Aiying Huang"
date: "2023-12-01"
output: 
  pdf_document:
    latex_engine: xelatex
---


# 描述性统计

## 变量分布

```{r}
#| echo: false
#| message: false
# Load necessary libraries
library(dplyr)
library(tidyr)
library(ggplot2)
library(GGally)
library(gridExtra)

# Read the data
data <- read.csv("./Project_1_data.csv")

# 1. Descriptive statistics table for all variables
skimr::skim(data)

# 2. Explore distribution of results and consider potential transformations
# Histograms for continuous variables
hist_math <- ggplot(data, aes(x = MathScore)) + geom_histogram(bins = 30) + ggtitle("Histogram of Math Scores")
hist_reading <- ggplot(data, aes(x = ReadingScore)) + geom_histogram(bins = 30) + ggtitle("Histogram of Reading Scores")
hist_writing <- ggplot(data, aes(x = WritingScore)) + geom_histogram(bins = 30) + ggtitle("Histogram of Writing Scores")

# Boxplots for continuous variables to check for outliers
box_math <- ggplot(data, aes(y = MathScore)) + geom_boxplot() + ggtitle("Boxplot of Math Scores")
box_reading <- ggplot(data, aes(y = ReadingScore)) + geom_boxplot() + ggtitle("Boxplot of Reading Scores")
box_writing <- ggplot(data, aes(y = WritingScore)) + geom_boxplot() + ggtitle("Boxplot of Writing Scores")

# Grid of plots
grid.arrange(hist_math, hist_reading, hist_writing, box_math, box_reading, box_writing, ncol = 3)

# 3. Check for potential outliers or influential points
# Scatterplot matrix for continuous variables
ggpairs(data, columns = c("MathScore", "ReadingScore", "WritingScore"))

```


## 缺失值

```{r}
#| echo: false
#| message: false
# Load necessary libraries
library(ggplot2)
library(reshape2)


# Creating a function to count NA and empty strings as missing values
count_missing <- function(x) sum(is.na(x) | x == "")
# Calculating the missing values
missing_values <- sapply(data, function(x) count_missing(x))

# Creating a dataframe for missing values
missing_data_frame <- data.frame(Variable = names(missing_values), MissingValues = missing_values)

# Convert empty strings to NA
data[data == ""] <- NA

# Melt the data for visualization
melted_data <- melt(data.frame(row = 1:nrow(data), data), id.vars = 'row')

# Creating the heatmap
ggplot(melted_data, aes(x = variable, y = row)) + 
  geom_tile(aes(fill = is.na(value))) + 
  scale_fill_manual(values = c('white', 'red'), guide = FALSE) + 
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = 'Variables', y = 'Observation Rows', title = 'Missing Data Heatmap')
```
```{r}
#| echo: false
#| message: false
missing_data_frame
```




# 数据预处理

## 缺失值填补

```{r}
#| echo: false
#| message: false
# Imputing missing values
# For columns with fewer missing values, replace with mode
get_mode <- function(v) {
  uniqv <- unique(v)
  uniqv[which.max(tabulate(match(v, uniqv)))]
}

data$PracticeSport[is.na(data$PracticeSport)] <- get_mode(data$PracticeSport)
data$IsFirstChild[is.na(data$IsFirstChild)] <- get_mode(data$IsFirstChild)

# For columns with more missing values, you can choose to impute or drop
# Imputing with mode (as an example)
data$EthnicGroup[is.na(data$EthnicGroup)] <- get_mode(data$EthnicGroup)
data$ParentEduc[is.na(data$ParentEduc)] <- get_mode(data$ParentEduc)
data$TestPrep[is.na(data$TestPrep)] <- get_mode(data$TestPrep)
data$ParentMaritalStatus[is.na(data$ParentMaritalStatus)] <- get_mode(data$TestPrep)
data$WklyStudyHours[is.na(data$WklyStudyHours)]<- get_mode(data$WklyStudyHours)
data$NrSiblings[is.na(data$NrSiblings)] <- mean(data$NrSiblings,na.rm = TRUE)

# Alternatively, to drop rows with NA values in these columns-TransportMeans
data <- data %>% drop_na(TransportMeans)
```


```{r}
#| echo: false
#| message: false
# Creating a function to count NA and empty strings as missing values
count_missing <- function(x) sum(is.na(x) | x == "")
# Calculating the missing values
missing_values <- sapply(data, function(x) count_missing(x))

# Creating a dataframe for missing values
missing_data_frame <- data.frame(Variable = names(missing_values), MissingValues = missing_values)

```





# 检查变量之间的边际分布和成对关系-correlation/pairwise-带修改完善
## Examine the marginal distributions and pairwise relationships between variables

```{r}
# Load necessary libraries
library(tidyverse)
library(ggplot2) 
library(GGally)

# draw the pariplot
ggpairs(data, columns=1:14, aes(alpha = 0.3))+ 
  theme_bw()
```
这边感觉没有别的办法了，最后都是这个14*14的图，感觉不行我们直接这样然后说没看到obvious nonlinearities

## Correlation between variables
```{r}
# Load necessary libraries
library(greybox)
library(tidyverse)
library(corrplot)

# Compute the Cramer's V correlation between variables
cramer_v_matrix <- assoc(data, method = "auto")

# Extract the matrix with Cramer's V values
cramer_v_values <- as.matrix(cramer_v_matrix$value)

# Print the correlation matrix results
knitr::kable(cramer_v_values, digits = 3)

# Create a heatmap
corrplot(cramer_v_values, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)
```
（这个变量的解释）Cramér's V (for categorical variables) varies from 0 (corresponding to no association between the variables) to 1 (complete association) and can reach 1 only when each variable is completely determined by the other.

这边有很多no relation的（很正常），但没有哪两个是colinear的
这个heatmap感觉可以不用放了，很奇怪，最后直接到table就好？



# 模型构建

```{r}
#| echo: false
#| message: false
# Load necessary libraries
library(tidyverse)
library(caret)
library(car)

set.seed(123) 
splitRatio <- 0.8

trainIndex <- sample(seq_len(nrow(data)), size = floor(splitRatio * nrow(data)))
trainData <- data[trainIndex, ]
testData <- data[-trainIndex, ]

# Splitting the train dataset into independent variables (X) and dependent variables (Y)
X_train <- trainData %>% select(-c(MathScore, ReadingScore, WritingScore))
Y_math_train <- trainData$MathScore
Y_reading_train <-trainData$ReadingScore
Y_writing_train <- trainData$WritingScore
```

## add interation

```{r}
#| echo: false
#| message: false
# Checking for interaction effects (example for math score)
full_model_math_interaction <- lm(Y_math_train ~  (.)^2, data = X_train)
full_model_reading_interaction <- lm(Y_reading_train ~  (.)^2, data = X_train)
full_model_writing_interaction <- lm(Y_writing_train ~  (.)^2, data = X_train)
```




## 模型选择

```{r}
#| echo: false
#| message: false
# backward (compare)
AICmodel_math_interaction = 
  step(full_model_math_interaction, trace = 0, direction='backward')
BICmodel_math_interaction = 
  step(full_model_math_interaction, scale = log(nrow(X_train)), trace = 0, direction='backward')

#参数全部输出有点太多了，仅仅输出参数数量进行对比
num_params_AICmodel <- length(coef(AICmodel_math_interaction))
num_params_BICmodel <- length(coef(BICmodel_math_interaction))

cat("AIC Model Parameters:", num_params_AICmodel, "\n")
cat("BIC Model Parameters:", num_params_BICmodel, "\n")

```

```{r}
#| echo: false
#| message: false
#此处解释因为bic做准则比aic的变量多，我们倾向选择变量少的
model_math_interaction = AICmodel_math_interaction
model_reading_interaction =
  step(full_model_reading_interaction, trace = 0, direction='backward')
model_writing_interaction =
  step(full_model_writing_interaction, trace = 0, direction='backward')

# results
# r.squared..
glance_math = broom::glance(model_math_interaction) |>
  mutate(model = "Math") |>
  select(model, r.squared, adj.r.squared, p.value, AIC, BIC) 

glance_reading = broom::glance(model_reading_interaction) |>
  mutate(model = "Reading") |>
  select(model, r.squared, adj.r.squared, p.value, AIC, BIC) 

glance_writing = broom::glance(model_writing_interaction) |>
  mutate(model = "Writing") |>
  select(model, r.squared, adj.r.squared, p.value, AIC, BIC) 

bind_rows(glance_math, glance_reading, glance_writing) |>
  knitr::kable()
  
# coef
broom::tidy(model_math_interaction) |>
  knitr::kable(caption = "Math")
broom::tidy(model_reading_interaction) |>
  knitr::kable(caption = "Reading")
broom::tidy(model_writing_interaction) |>
  knitr::kable(caption = "Writing")
```

```{r}
#| echo: false
#| message: false
par(mfrow=c(2,2))
plot(model_math_interaction) 
mtext("Math Model Diagnostic", outer = TRUE, cex = 1, line = -1)

plot(model_reading_interaction)
mtext("Reading Model Diagnostic", outer = TRUE, cex = 1, line = -1)

plot(model_writing_interaction)
mtext("Writing Model Diagnostic", outer = TRUE, cex = 1, line = -1)
```
## Influential observations(mathmodel删掉了ParentEduc:ParentMaritalStatus不然有na)


```{r}
#| echo: false
#| message: false
# remove influential points from the residual and leverage plots
X_train_math_Out =X_train[-c(49,181,557,642),]
Y_math_train_Out=Y_math_train[-c(49,181,557,642)]
X_train_reading_Out =X_train[-c(181,252,268),]
Y_reading_train_Out=Y_reading_train[-c(181,252,268)]
X_train_writing_Out =X_train[-c(5,268,281),]
Y_writing_train_Out=Y_writing_train[-c(5,268,281)]
# fit model without influential points
without_math = lm(Y_math_train_Out ~  Gender + EthnicGroup + ParentEduc + 
    LunchType + TestPrep + ParentMaritalStatus + PracticeSport + 
    IsFirstChild + NrSiblings + TransportMeans + WklyStudyHours + 
    Gender:LunchType + Gender:PracticeSport + EthnicGroup:ParentEduc + 
    EthnicGroup:IsFirstChild + ParentEduc:TestPrep + 
    ParentEduc:PracticeSport + ParentEduc:IsFirstChild + LunchType:PracticeSport + 
    LunchType:TransportMeans + TestPrep:WklyStudyHours + ParentMaritalStatus:PracticeSport + 
    ParentMaritalStatus:IsFirstChild + ParentMaritalStatus:TransportMeans + 
    PracticeSport:WklyStudyHours + IsFirstChild:NrSiblings + 
    IsFirstChild:TransportMeans + IsFirstChild:WklyStudyHours, data = X_train_math_Out)
without_reading = lm(Y_reading_train_Out ~ Gender + EthnicGroup + ParentEduc + 
    LunchType + TestPrep + ParentMaritalStatus + PracticeSport + 
    IsFirstChild + NrSiblings + TransportMeans + WklyStudyHours + 
    Gender:IsFirstChild + LunchType:PracticeSport + LunchType:IsFirstChild + 
    TestPrep:NrSiblings + TestPrep:TransportMeans + ParentMaritalStatus:PracticeSport + 
    ParentMaritalStatus:IsFirstChild + PracticeSport:WklyStudyHours + 
    NrSiblings:WklyStudyHours, data = X_train_reading_Out)
without_writing = lm(Y_writing_train_Out ~ Gender + EthnicGroup + ParentEduc + 
    LunchType + TestPrep + ParentMaritalStatus + PracticeSport + 
    IsFirstChild + NrSiblings + TransportMeans + WklyStudyHours + 
    ParentEduc:IsFirstChild + LunchType:PracticeSport + LunchType:IsFirstChild + 
    TestPrep:NrSiblings + ParentMaritalStatus:PracticeSport + 
    ParentMaritalStatus:IsFirstChild + PracticeSport:WklyStudyHours + 
    IsFirstChild:WklyStudyHours, data = X_train_writing_Out)
# results
# r.squared..
glance_math_new = broom::glance(without_math) |>
  mutate(model = "Math") |>
  select(model, r.squared, adj.r.squared, p.value, AIC, BIC) 

glance_reading_new = broom::glance(without_reading ) |>
  mutate(model = "Reading") |>
  select(model, r.squared, adj.r.squared, p.value, AIC, BIC) 

glance_writing_new = broom::glance(without_writing) |>
  mutate(model = "Writing") |>
  select(model, r.squared, adj.r.squared, p.value, AIC, BIC) 

bind_rows(glance_math_new, glance_reading_new, glance_writing_new) |>
  knitr::kable()

```

## multicolinearity-没有强烈的多重共线性问题

```{r}
#| echo: false
#| message: false
# 计算方差膨胀因子（GVIF）
vif_values_math <- vif(without_math , type = 'predictor')
print(vif_values_math)
vif_values_writing <- vif(without_writing, type = 'predictor')
print(vif_values_writing)
vif_values_reading <- vif(without_reading, type = 'predictor')
print(vif_values_reading)
#没有强烈的多重共线性问题
```

## model validation

# cross validation
```{r}
#| echo: false
#| message: false
library(caret)
control <- trainControl(method = "cv", number = 10)
set.seed(123)

math_model_data <- cbind(X_train_math_Out, Y_math_train_Out)
math_model_cv <- train(Y_math_train_Out ~ Gender + EthnicGroup + ParentEduc + 
    LunchType + TestPrep + ParentMaritalStatus + PracticeSport + 
    IsFirstChild + NrSiblings + TransportMeans + WklyStudyHours + 
    Gender:LunchType + Gender:PracticeSport + EthnicGroup:ParentEduc + 
    EthnicGroup:IsFirstChild + ParentEduc:TestPrep + ParentEduc:PracticeSport + 
    ParentEduc:IsFirstChild + LunchType:PracticeSport + LunchType:TransportMeans + 
    TestPrep:WklyStudyHours + ParentMaritalStatus:PracticeSport + 
    ParentMaritalStatus:IsFirstChild + ParentMaritalStatus:TransportMeans + 
    PracticeSport:WklyStudyHours + IsFirstChild:NrSiblings + 
    IsFirstChild:TransportMeans + IsFirstChild:WklyStudyHours, 
    data = math_model_data, method = "lm", trControl = control)

set.seed(124)

reading_model_data <- cbind(X_train_reading_Out, Y_reading_train_Out)
reading_model_cv <- train( Y_reading_train_Out ~ Gender + EthnicGroup + ParentEduc + 
    LunchType + TestPrep + ParentMaritalStatus + PracticeSport + 
    IsFirstChild + NrSiblings + TransportMeans + WklyStudyHours + 
    Gender:IsFirstChild + LunchType:PracticeSport + LunchType:IsFirstChild + 
    TestPrep:NrSiblings + TestPrep:TransportMeans + ParentMaritalStatus:PracticeSport + 
    ParentMaritalStatus:IsFirstChild + PracticeSport:WklyStudyHours + 
    NrSiblings:WklyStudyHours, data = reading_model_data, 
    method = "lm", trControl = control)

set.seed(125)

writing_model_data <- cbind(X_train_writing_Out, Y_writing_train_Out)
writing_model_cv <- train(Y_writing_train_Out ~ Gender + EthnicGroup + ParentEduc + 
    LunchType + TestPrep + ParentMaritalStatus + PracticeSport + 
    IsFirstChild + NrSiblings + TransportMeans + WklyStudyHours + 
    ParentEduc:IsFirstChild + LunchType:PracticeSport + LunchType:IsFirstChild + 
    TestPrep:NrSiblings + ParentMaritalStatus:PracticeSport + 
    ParentMaritalStatus:IsFirstChild + PracticeSport:WklyStudyHours + 
    IsFirstChild:WklyStudyHours, data = writing_model_data, 
    method = "lm", trControl = control)


print(math_model_cv)
print(reading_model_cv)
print(writing_model_cv)


```

```{r}
#| echo: false
#| message: false
library(readr)
library(dplyr)
library(ggplot2)
library(caret)
library(purrr)
library(tidyverse)
library(plotly)
library(modelr)
library(tidyr)
library(randomForest)
library(boot)
library(patchwork)

set.seed(123)
# generate a cv dataframe 
cv_df_math =
  crossv_mc(math_model_data, 10) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))

# fit the model to the generated CV dataframe
cv_df_math =
  cv_df_math |> 
  mutate(
    model  = map(train, ~lm( Y_math_train_Out ~ Gender + EthnicGroup + ParentEduc + 
    LunchType + TestPrep + ParentMaritalStatus + PracticeSport + 
    IsFirstChild + NrSiblings + TransportMeans + WklyStudyHours + 
    Gender:LunchType + Gender:PracticeSport + EthnicGroup:ParentEduc + 
    EthnicGroup:IsFirstChild + ParentEduc:TestPrep + ParentEduc:PracticeSport + 
    ParentEduc:IsFirstChild + LunchType:PracticeSport + LunchType:TransportMeans + 
    TestPrep:WklyStudyHours + ParentMaritalStatus:PracticeSport + 
    ParentMaritalStatus:IsFirstChild + ParentMaritalStatus:TransportMeans + 
    PracticeSport:WklyStudyHours + IsFirstChild:NrSiblings + 
    IsFirstChild:TransportMeans + IsFirstChild:WklyStudyHours, data = math_model_data)),
    rmse = map2_dbl(model, test, ~rmse(model = .x, data = .y)))

# plot the prediction error
plot_math <- cv_df_math |>
  select(rmse) |> 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse") %>% 
  ggplot(aes(x = model, y = rmse)) + 
  geom_violin(fill = "blue", alpha = 0.5) +
  labs(
    x = "MLR",
    y = "Prediction Errors"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text = element_text(color = "grey20"),
    axis.title = element_text(color = "grey20")
  )


set.seed(123)
# generate a cv dataframe 
cv_df_reading =
  crossv_mc(reading_model_data, 10) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))

# fit the model to the generated CV dataframe
cv_df_reading =
  cv_df_reading |> 
  mutate(
    model  = map(train, ~lm(Y_reading_train_Out ~ Gender + EthnicGroup + ParentEduc + 
    LunchType + TestPrep + ParentMaritalStatus + PracticeSport + 
    IsFirstChild + NrSiblings + TransportMeans + WklyStudyHours + 
    Gender:IsFirstChild + LunchType:PracticeSport + LunchType:IsFirstChild + 
    TestPrep:NrSiblings + TestPrep:TransportMeans + ParentMaritalStatus:PracticeSport + 
    ParentMaritalStatus:IsFirstChild + PracticeSport:WklyStudyHours + 
    NrSiblings:WklyStudyHours, data = reading_model_data)),
    rmse = map2_dbl(model, test, ~rmse(model = .x, data = .y)))

# plot the prediction error
plot_reading <- cv_df_reading |>
  select(rmse) |> 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse") %>% 
  ggplot(aes(x = model, y = rmse)) + 
  geom_violin(fill = "pink", alpha = 0.5) +
  labs(
    x = "MLR",
    y = "Prediction Errors"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text = element_text(color = "grey20"),
    axis.title = element_text(color = "grey20")
  )

set.seed(123)
# generate a cv dataframe 
cv_df_writing =
  crossv_mc(writing_model_data, 10) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))

# fit the model to the generated CV dataframe
cv_df_writing =
  cv_df_writing |> 
  mutate(
    model  = map(train, ~lm(Y_writing_train_Out ~ Gender + EthnicGroup + ParentEduc + 
    LunchType + TestPrep + ParentMaritalStatus + PracticeSport + 
    IsFirstChild + NrSiblings + TransportMeans + WklyStudyHours + 
    ParentEduc:IsFirstChild + LunchType:PracticeSport + LunchType:IsFirstChild + 
    TestPrep:NrSiblings + ParentMaritalStatus:PracticeSport + 
    ParentMaritalStatus:IsFirstChild + PracticeSport:WklyStudyHours + 
    IsFirstChild:WklyStudyHours, data = writing_model_data)),
    rmse = map2_dbl(model, test, ~rmse(model = .x, data = .y)))

# plot the prediction error
plot_writing <-cv_df_writing |>
  select(rmse) |> 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse") %>% 
  ggplot(aes(x = model, y = rmse)) + 
  geom_violin(fill = "yellow", alpha = 0.5) +
  labs(
    x = "MLR",
    y = "Prediction Errors"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text = element_text(color = "grey20"),
    axis.title = element_text(color = "grey20")
  )
# 组合图形
combined_plot <- plot_math + plot_reading + plot_writing+plot_annotation(title="Prediction Errors For Models Under CV")

# 打印组合后的图形
combined_plot
```



# prediction

```{r}
#| echo: false
#| message: false
# Splitting the train dataset into independent variables (X) and dependent variables (Y)
X_test<- testData %>% select(-c(MathScore, ReadingScore, WritingScore))
Y_math_test <- testData$MathScore
Y_reading_test <-testData$ReadingScore
Y_writing_test <- testData$WritingScore
```
```{r}
#| echo: false
#| message: false
final_math=lm(Y_math_train_Out ~ Gender + EthnicGroup + ParentEduc + 
    LunchType + TestPrep + ParentMaritalStatus + PracticeSport + 
    IsFirstChild + NrSiblings + TransportMeans + WklyStudyHours + 
    Gender:LunchType + Gender:PracticeSport + EthnicGroup:ParentEduc + 
    EthnicGroup:IsFirstChild + ParentEduc:TestPrep + ParentEduc:PracticeSport + 
    ParentEduc:IsFirstChild + LunchType:PracticeSport + LunchType:TransportMeans + 
    TestPrep:WklyStudyHours + ParentMaritalStatus:PracticeSport + 
    ParentMaritalStatus:IsFirstChild + ParentMaritalStatus:TransportMeans + 
    PracticeSport:WklyStudyHours + IsFirstChild:NrSiblings + 
    IsFirstChild:TransportMeans + IsFirstChild:WklyStudyHours, 
    data = math_model_data)
final_reading=lm(Y_reading_train_Out ~ Gender + EthnicGroup + ParentEduc + 
    LunchType + TestPrep + ParentMaritalStatus + PracticeSport + 
    IsFirstChild + NrSiblings + TransportMeans + WklyStudyHours + 
    Gender:IsFirstChild + LunchType:PracticeSport + LunchType:IsFirstChild + 
    TestPrep:NrSiblings + TestPrep:TransportMeans + ParentMaritalStatus:PracticeSport + 
    ParentMaritalStatus:IsFirstChild + PracticeSport:WklyStudyHours + 
    NrSiblings:WklyStudyHours, data = reading_model_data)
final_writing=lm(Y_writing_train_Out ~ Gender + EthnicGroup + ParentEduc + 
    LunchType + TestPrep + ParentMaritalStatus + PracticeSport + 
    IsFirstChild + NrSiblings + TransportMeans + WklyStudyHours + 
    ParentEduc:IsFirstChild + LunchType:PracticeSport + LunchType:IsFirstChild + 
    TestPrep:NrSiblings + ParentMaritalStatus:PracticeSport + 
    ParentMaritalStatus:IsFirstChild + PracticeSport:WklyStudyHours + 
    IsFirstChild:WklyStudyHours, data = writing_model_data)
```



```{r}
#| echo: false
#| message: false
math_predictions <- predict(final_math, newdata = X_test)
reading_predictions <- predict(final_reading, newdata = X_test)
writing_predictions <- predict(final_writing, newdata = X_test)
```

```{r}
#| echo: false
#| message: false
math_mspe <- mean((Y_math_test - math_predictions)^2)
reading_mspe <- mean((Y_reading_test - reading_predictions)^2)
writing_mspe <- mean((Y_writing_test - writing_predictions)^2)
mspe_values <- data.frame(
  Subject = c("Math", "Reading", "Writing"),
  MSPE = c(math_mspe, reading_mspe, writing_mspe)
)
library(knitr)

kable(mspe_values, col.names = c("Subject", "MSPE"), caption = "MSPE Values for Different Subjects")
```









